name: Deploy to Test Server

on:
  push:
    branches:
      - dev # Test se despliega desde develop
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub UI

env:
  DEPLOY_PATH: C:\deploy\SistemaDeTicketsTest
  COMPOSE_FILE: docker-compose.test.yml

jobs:
  deploy:
    name: Build and Deploy to Test Server
    runs-on: [self-hosted, Windows, X64, test, tickets] # Ejecuta solo en runners Windows con label "test" y "tickets"

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          clean: false

      - name: üìÇ Create deploy directory
        run: |
          if (-not (Test-Path "$env:DEPLOY_PATH")) {
            New-Item -Path "$env:DEPLOY_PATH" -ItemType Directory -Force
            Write-Host "OK: Directorio de despliegue creado"
          }
        shell: powershell

      - name: üìã Copy .env if not exists
        run: |
          if (-not (Test-Path "$env:DEPLOY_PATH\.env")) {
            if (Test-Path '.env.example') {
              Copy-Item -Path '.env.example' -Destination "$env:DEPLOY_PATH\.env" -Force
              Write-Host "WARNING: Archivo .env creado desde template"
              Write-Host "WARNING: IMPORTANTE: Configurar manualmente con credenciales de TEST"
            }
          } else {
            Write-Host "INFO: Archivo .env ya existe"
          }
        shell: powershell

      - name: üöÄ Deploy files to test server
        run: |
          Write-Host "INFO: Desplegando archivos..."
          Write-Host "INFO: Directorio fuente: $(Get-Location)"
          Write-Host "INFO: Directorio destino: $env:DEPLOY_PATH"
          Write-Host ""
          Write-Host "=== DIAGNOSTICO DE DIRECTORIO ==="
          Write-Host "Contenido del directorio actual:"
          Get-ChildItem -Path . -Force | Select-Object Name, Length, LastWriteTime | Format-Table -AutoSize
          Write-Host ""
          Write-Host "Buscando Dockerfile recursivamente:"
          Get-ChildItem -Path . -Filter "Dockerfile" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
          Write-Host ""

          # Verificar que estamos en el directorio correcto
          if (-not (Test-Path "Dockerfile")) {
            Write-Host "ERROR: Dockerfile no encontrado en directorio actual"
            Write-Host "ERROR: Intentando buscar en subdirectorios..."

            $dockerfilePath = Get-ChildItem -Path . -Filter "Dockerfile" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($dockerfilePath) {
              Write-Host "WARNING: Dockerfile encontrado en: $($dockerfilePath.FullName)"
              Write-Host "ERROR: El checkout puede estar en un directorio incorrecto"
            }
            exit 1
          }

          # Copiar todos los archivos excepto .env y logs
          $excludeItems = @('.env', 'nginx/logs', '.git', 'README.md')
          $fileCount = 0

          Get-ChildItem -Path "." -Recurse | ForEach-Object {
            $shouldExclude = $false
            foreach ($exclude in $excludeItems) {
              if ($_.FullName -like "*$exclude*") {
                $shouldExclude = $true
                break
              }
            }

            if (-not $shouldExclude -and -not $_.PSIsContainer) {
              $relativePath = $_.FullName.Substring((Get-Location).Path.Length + 1)
              $destPath = Join-Path $env:DEPLOY_PATH $relativePath
              $destDir = Split-Path $destPath -Parent

              if (-not (Test-Path $destDir)) {
                New-Item -Path $destDir -ItemType Directory -Force | Out-Null
              }

              Copy-Item -Path $_.FullName -Destination $destPath -Force
              $fileCount++

              # Log archivos cr√≠ticos
              if ($_.Name -in @('Dockerfile', 'docker-compose.yml', 'docker-compose.test.yml')) {
                Write-Host "OK: Copiado $($_.Name) -> $destPath"
              }
            }
          }

          Write-Host "OK: $fileCount archivos desplegados en $env:DEPLOY_PATH"

          # Verificar que los archivos cr√≠ticos fueron copiados
          $criticalFiles = @('Dockerfile', 'docker-compose.test.yml')
          foreach ($file in $criticalFiles) {
            $filePath = Join-Path $env:DEPLOY_PATH $file
            if (Test-Path $filePath) {
              Write-Host "OK: Verificado $file en destino"
            } else {
              Write-Host "ERROR: $file NO fue copiado al destino"
              exit 1
            }
          }
        shell: powershell

      - name: üê≥ Verify Docker installation
        run: |
          Write-Host "INFO: Verificando instalaci√≥n de Docker..."

          # Verificar si Docker est√° disponible
          $dockerCmd = Get-Command docker -ErrorAction SilentlyContinue
          if (-not $dockerCmd) {
            Write-Host "ERROR: Docker no est√° instalado o no est√° en el PATH"
            Write-Host "ERROR: Por favor instala Docker Engine en Windows Server"
            exit 1
          }

          # Obtener versi√≥n de Docker
          try {
            $dockerVersion = docker --version 2>&1
            if ($LASTEXITCODE -ne 0) {
              throw "Docker no respondi√≥ correctamente"
            }
            Write-Host "OK: Docker instalado: $dockerVersion"
          } catch {
            Write-Host "ERROR: Docker est√° instalado pero no responde"
            Write-Host "ERROR: Verifica que el servicio Docker est√© corriendo: Get-Service docker"
            exit 1
          }

          # Verificar Docker Compose
          try {
            $composeVersion = docker compose version 2>&1
            if ($LASTEXITCODE -ne 0) {
              throw "Docker Compose no respondi√≥ correctamente"
            }
            Write-Host "OK: Docker Compose instalado: $composeVersion"
          } catch {
            Write-Host "ERROR: Docker Compose no est√° disponible"
            Write-Host "ERROR: Aseg√∫rate de tener Docker con plugin de Compose instalado"
            exit 1
          }

          # Verificar conectividad con el daemon de Docker
          try {
            docker ps > $null 2>&1
            if ($LASTEXITCODE -eq 0) {
              Write-Host "OK: Docker daemon est√° corriendo y accesible"
            } else {
              Write-Host "WARNING: Docker daemon no responde. Intentando iniciar el servicio..."
              Start-Service docker -ErrorAction Stop
              Start-Sleep -Seconds 5
              docker ps > $null 2>&1
              if ($LASTEXITCODE -eq 0) {
                Write-Host "OK: Servicio Docker iniciado correctamente"
              } else {
                throw "No se puede conectar al daemon de Docker"
              }
            }
          } catch {
            Write-Host "ERROR: No se puede conectar al daemon de Docker"
            Write-Host "ERROR: Verifica que el servicio est√© corriendo: Get-Service docker"
            Write-Host "ERROR: Si es necesario, inicia el servicio: Start-Service docker"
            exit 1
          }
        shell: powershell

      - name: üõë Stop current containers
        run: |
          cd $env:DEPLOY_PATH

          $composeFile = Join-Path $env:DEPLOY_PATH $env:COMPOSE_FILE
          if (Test-Path $composeFile) {
            Write-Host "INFO: Deteniendo contenedores existentes..."
            try {
              docker compose -f $env:COMPOSE_FILE down
              $downExitCode = $LASTEXITCODE
              if ($downExitCode -eq 0) {
                Write-Host "OK: Contenedores detenidos"
              } else {
                Write-Host "WARNING: Error al detener contenedores (Exit code: $downExitCode)"
                Write-Host "INFO: Intentando forzar limpieza de contenedores..."
                docker ps -a --filter "name=tickets_*_test" --format "{{.ID}}" | ForEach-Object {
                  docker rm -f $_ 2>&1 | Out-Null
                }
                Write-Host "OK: Limpieza forzada completada"
              }
            } catch {
              Write-Host "WARNING: No se pudieron detener los contenedores: $_"
              Write-Host "INFO: Continuando con el despliegue..."
            }
          } else {
            Write-Host "INFO: No hay archivo compose previo"
          }
        shell: powershell
        continue-on-error: true

      - name: üèóÔ∏è Build Docker images
        run: |
          cd $env:DEPLOY_PATH

          Write-Host "INFO: Construyendo im√°genes Docker..."
          Write-Host "INFO: Directorio actual: $(Get-Location)"
          Write-Host "INFO: Archivo compose: $env:COMPOSE_FILE"

          # Verificar que el Dockerfile existe
          if (-not (Test-Path "Dockerfile")) {
            Write-Host "ERROR: Dockerfile no encontrado en $(Get-Location)"
            Get-ChildItem -Path . -Force | Select-Object Name, LastWriteTime | Format-Table -AutoSize
            exit 1
          }

          # Construir sin cach√© para asegurar √∫ltima versi√≥n
          docker compose -f $env:COMPOSE_FILE build --no-cache
          $buildExitCode = $LASTEXITCODE

          if ($buildExitCode -eq 0) {
            Write-Host "OK: Im√°genes construidas exitosamente"
          } else {
            Write-Host "ERROR: Error al construir im√°genes (Exit code: $buildExitCode)"
            Write-Host "ERROR: Revisa los logs arriba para m√°s detalles"
            Write-Host ""
            Write-Host "--- INFORMACION DE DIAGNOSTICO ---"
            Write-Host "Docker version:"
            docker --version
            Write-Host ""
            Write-Host "Docker info:"
            docker info 2>&1 | Select-String -Pattern "Server Version|Operating System|OSType|Architecture"
            exit 1
          }
        shell: powershell

      - name: üöÄ Start containers
        run: |
          cd $env:DEPLOY_PATH

          Write-Host "INFO: Iniciando contenedores..."
          docker compose -f $env:COMPOSE_FILE up -d

          if ($LASTEXITCODE -eq 0) {
            Write-Host "OK: Contenedores iniciados exitosamente"
          } else {
            Write-Host "ERROR: Error al iniciar contenedores"
            exit 1
          }
        shell: powershell

      - name: üîç Verify containers status
        run: |
          cd $env:DEPLOY_PATH

          Write-Host "INFO: Verificando estado de contenedores..."
          Start-Sleep -Seconds 5

          $containers = docker compose -f $env:COMPOSE_FILE ps --format json | ConvertFrom-Json

          $allRunning = $true
          foreach ($container in $containers) {
            if ($container.State -ne "running") {
              Write-Host "ERROR: Contenedor $($container.Service) no est√° corriendo. Estado: $($container.State)"
              $allRunning = $false
            } else {
              Write-Host "OK: Contenedor $($container.Service) corriendo correctamente"
            }
          }

          if (-not $allRunning) {
            Write-Host "ERROR: Algunos contenedores no est√°n corriendo correctamente"
            Write-Host "--- LOGS DE NGINX ---"
            docker compose -f $env:COMPOSE_FILE logs nginx
            Write-Host "--- LOGS DE PHP ---"
            docker compose -f $env:COMPOSE_FILE logs php
            exit 1
          }
        shell: powershell

      - name: üè• Health check
        continue-on-error: true
        run: |
          cd $env:DEPLOY_PATH

          Write-Host "INFO: Verificando salud de los contenedores..."
          Start-Sleep -Seconds 5

          # Verificar que los contenedores est√©n running
          $containers = docker compose -f $env:COMPOSE_FILE ps --format json | ConvertFrom-Json

          $allHealthy = $true
          foreach ($container in $containers) {
            if ($container.State -eq "running") {
              Write-Host "OK: Contenedor $($container.Service) est√° corriendo"
            } else {
              Write-Host "WARNING: Contenedor $($container.Service) no est√° corriendo. Estado: $($container.State)"
              $allHealthy = $false
            }
          }

          if ($allHealthy) {
            Write-Host "OK: Todos los contenedores est√°n corriendo correctamente"
          } else {
            Write-Host "WARNING: Algunos contenedores tienen problemas"
          }

          # Leer puerto del .env para informar
          $port = 9006
          if (Test-Path "$env:DEPLOY_PATH\.env") {
            $envContent = Get-Content "$env:DEPLOY_PATH\.env"
            foreach ($line in $envContent) {
              if ($line -match "HTTP_PORT_TEST=(\d+)") {
                $port = $matches[1]
                break
              }
            }
          }

          Write-Host ""
          Write-Host "INFO: Aplicacion disponible en: http://localhost:$port"
          Write-Host "INFO: Si necesitas verificar logs: docker compose -f $env:COMPOSE_FILE logs -f"

          # Intentar verificar HTTP (opcional)
          $maxAttempts = 5
          $attempt = 0

          while ($attempt -lt $maxAttempts) {
            try {
              Start-Sleep -Seconds 2
              $response = Invoke-WebRequest -Uri "http://localhost:$port" -UseBasicParsing -TimeoutSec 5 -ErrorAction Stop

              if ($response.StatusCode -eq 200) {
                Write-Host "OK: Servidor HTTP respondiendo correctamente: $($response.StatusCode)"
                break
              }
            } catch {
              $attempt++
              if ($attempt -lt $maxAttempts) {
                Write-Host "INFO: Intento $attempt/$maxAttempts - Esperando respuesta HTTP..."
              }
            }
          }

          if ($attempt -ge $maxAttempts) {
            Write-Host ""
            Write-Host "INFO: No se pudo verificar HTTP despu√©s de $maxAttempts intentos"
            Write-Host "INFO: Esto es normal si la aplicaci√≥n requiere configuraci√≥n adicional"
            Write-Host "INFO: Los contenedores est√°n corriendo. Verifica manualmente en: http://localhost:$port"
            Write-Host ""
          } else {
            Write-Host "OK: Verificaci√≥n HTTP exitosa"
          }
        shell: powershell

      - name: üßπ Clean old images
        run: |
          Write-Host "INFO: Limpiando im√°genes antiguas..."
          docker image prune -f
          Write-Host "OK: Im√°genes antiguas eliminadas"
        shell: powershell
        continue-on-error: true

      - name: üìä Deployment summary
        run: |
          cd $env:DEPLOY_PATH

          # Leer el puerto del archivo .env
          $envContent = Get-Content "$env:DEPLOY_PATH\.env"
          $port = 9006
          foreach ($line in $envContent) {
            if ($line -match "HTTP_PORT_TEST=(\d+)") {
              $port = $matches[1]
              break
            }
          }

          Write-Host ''
          Write-Host "============================================================="
          Write-Host "     DESPLIEGUE EN TEST COMPLETADO EXITOSAMENTE"
          Write-Host "============================================================="
          Write-Host ''
          Write-Host "Ubicacion: $env:DEPLOY_PATH"
          Write-Host "URL: http://localhost:$port"
          Write-Host "Fecha: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")"
          Write-Host "Commit: $env:GITHUB_SHA"
          Write-Host "Autor: $env:GITHUB_ACTOR"
          Write-Host ''
          Write-Host "Contenedores corriendo:"
          docker compose -f $env:COMPOSE_FILE ps
          Write-Host ''
          Write-Host "OK: Servidor de TEST actualizado y corriendo"
          Write-Host ''
        shell: powershell

      - name: üìß Notify on failure
        if: failure()
        shell: powershell
        run: |
          Write-Host ''
          Write-Host '============================================================='
          Write-Host '          DESPLIEGUE EN TEST FALLO'
          Write-Host '============================================================='
          Write-Host ''
          Write-Host 'INFO: Revisa los logs del workflow en GitHub Actions'
          Write-Host 'INFO: Revisa los logs de contenedores con:'
          Write-Host ('       docker compose -f ' + $env:COMPOSE_FILE + ' logs')
          Write-Host ''
